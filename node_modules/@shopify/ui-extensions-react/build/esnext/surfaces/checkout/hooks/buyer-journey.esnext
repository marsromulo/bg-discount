import { useRef, useEffect } from 'react';
import { ExtensionHasNoMethodError } from '../errors.esnext';
import { useApi } from './api.esnext';
import { useSubscription } from './subscription.esnext';

/**
 * Returns the `buyerJourney` details on buyer progression in checkout.
 */
function useBuyerJourney() {
  const api = useApi();
  if ('buyerJourney' in api) {
    return api.buyerJourney;
  }
  throw new ExtensionHasNoMethodError('applyAttributeChange', api.extension.target);
}

/**
 * Returns true if the buyer completed submitting their order.
 *
 * For example, when viewing the order status page after submitting payment, the buyer will have completed their order.
 */
function useBuyerJourneyCompleted() {
  const api = useApi();
  if ('buyerJourney' in api) {
    return useSubscription(api.buyerJourney.completed);
  }
  throw new ExtensionHasNoMethodError('buyerJourney', api.extension.target);
}

/**
 * Installs a function for intercepting and preventing progress on checkout.
 *
 * To block checkout progress, you must set the [block_progress](https://shopify.dev/docs/api/checkout-ui-extensions/configuration#block-progress)
 * capability in your extension's configuration.
 *
 * If you do, then you're expected to inform the buyer why navigation was blocked,
 * either by passing validation errors to the checkout UI or rendering the errors in your extension.
 */
function useBuyerJourneyIntercept(interceptor) {
  const api = useApi();
  if (!('buyerJourney' in api)) {
    throw new ExtensionHasNoMethodError('buyerJourney', api.extension.target);
  }
  const interceptorRef = useRef(interceptor);
  interceptorRef.current = interceptor;
  return useEffect(() => {
    const teardownPromise = api.buyerJourney.intercept(interceptorProps => interceptorRef.current(interceptorProps));
    return () => {
      teardownPromise.then(teardown => teardown()).catch(() => {});
    };
  }, [api.buyerJourney]);
}

export { useBuyerJourney, useBuyerJourneyCompleted, useBuyerJourneyIntercept };
